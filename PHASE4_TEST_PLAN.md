# Phase 4: Prompt 優化與 AI 測試計畫

## 📊 測試目標

1. ✅ 驗證 Prompt 長度已精簡至 800-1200 字
2. ✅ 驗證 AI 判斷準確率 > 85%
3. ✅ 驗證 Prior Weight 機制正常運作
4. ✅ 驗證 AI 偏離提醒機制正確觸發

---

## 🧪 測試 1: Prompt 長度驗證

### 目標
確認新的 Prompt 已從原本的 1500-2200 字精簡至 800-1200 字。

### 測試方法
在瀏覽器開發者工具中執行以下代碼：

```javascript
// 在 Console 中執行
const testPrompt = (priorWeights, domain) => {
  const typeLabels = priorWeights.map((t, i) => {
    const priority = i === 0 ? '最優先' : i === 1 ? '次優先' : '最後'
    const typeName = t === 1 ? 'Type 1（唯一答案）' : t === 2 ? 'Type 2（多答案可接受）' : 'Type 3（依表現給分）'
    return `${priority}：${typeName}`
  }).join('、')

  const base = `從標準答案圖片提取可機器批改的答案表。回傳純 JSON（無 Markdown）：

{
  "questions": [{
    "id": "1",
    "type": 1 | 2 | 3,
    "maxScore": 5,
    "answer": "正確答案",
    "referenceAnswer": "範例答案",
    "acceptableAnswers": ["同義詞1", "同義詞2"],
    "rubricsDimensions": [
      {"name": "計算過程", "maxScore": 3, "criteria": "步驟清晰"},
      {"name": "最終答案", "maxScore": 2, "criteria": "答案正確"}
    ],
    "rubric": {
      "levels": [
        {"label": "優秀", "min": 9, "max": 10, "criteria": "邏輯清晰完整"},
        {"label": "良好", "min": 7, "max": 8, "criteria": "大致正確"},
        {"label": "尚可", "min": 5, "max": 6, "criteria": "部分正確"},
        {"label": "待努力", "min": 1, "max": 4, "criteria": "多處錯誤"}
      ]
    },
    "aiDivergedFromPrior": false,
    "aiOriginalDetection": 1
  }],
  "totalScore": 50
}

【題型分類標準】
- Type 1（唯一答案）：精確匹配，答案唯一且不可替換（如：2+3=5、選擇A）
- Type 2（多答案可接受）：核心答案固定但允許不同表述（如：「光合作用」vs「植物製造養分」）
- Type 3（依表現給分）：開放式或計算題，需評分規準
  · 計算題：用 rubricsDimensions，維度通常包括「計算過程」和「最終答案」
  · 申論題：有明確答案要點時用 rubricsDimensions（如：「列舉三個優點」）
            純評價題時用 rubric 4級評價（如：「你對此事的看法」）

【規則】
- 題號：圖片有就用，無則1, 2, 3...（不可跳號）
- 配分：圖片有就用，無則估計（是非/選擇2-5分，簡答5-8分，申論8-15分）
- totalScore = 所有 maxScore 總和
- 無法辨識時回傳 {"questions": [], "totalScore": 0}`

  const priorHint = `

【Prior Weight - 教師指定題型偏好】
教師指定此作業的題型優先級：${typeLabels}

請優先按此順序判斷，但若遇到強烈證據顯示不符時（例如明顯的申論題但教師優先Type 1），可偏離並設定：
- "aiDivergedFromPrior": true
- "aiOriginalDetection": <你的判斷類型>

注意：只在強烈證據時才偏離，一般情況應遵循教師的Prior Weight。`

  const domainHints = {
    '國語': '關鍵字優先，避免抄全文',
    '數學': '數值+單位完整，公式需核心部分',
    '社會': '專注同音異字（如：九州≠九洲）',
    '自然': '名詞/數值/單位必須完整',
    '英語': '拼字/大小寫需精確'
  }

  const domainHint = domain && domainHints[domain]
    ? `\n\n【${domain}提示】${domainHints[domain]}`
    : ''

  const fullPrompt = base + priorHint + domainHint
  console.log('Prompt 字數:', fullPrompt.length)
  console.log('完整 Prompt:', fullPrompt)
  return fullPrompt.length
}

// 測試不同場景
console.log('場景1 (單選):', testPrompt([2], '數學'))
console.log('場景2 (雙選):', testPrompt([2, 1], '國語'))
console.log('場景3 (三選):', testPrompt([2, 1, 3], '自然'))
console.log('場景4 (無領域):', testPrompt([2], undefined))
```

### 預期結果
- ✅ 所有場景的字數應在 **800-1200 字**之間
- ✅ Prior Weight 提示正確顯示優先級順序
- ✅ 領域提示簡潔清晰

---

## 🧪 測試 2: Prior Weight 機制驗證

### 測試用例 1: 單一優先級
**設定**: Prior Weight = [Type 2]
**測試題目**: 混合型作業（包含是非、填空、申論）

**步驟**:
1. 創建新作業，選擇 Prior Weight: Type 2（多答案可接受）
2. 上傳包含以下題目的標準答案：
   - 是非題：「對或錯」
   - 填空題：「光合作用」
   - 簡答題：「說明水循環過程」
   - 申論題：「你對環保的看法」

**預期結果**:
- ✅ 是非題：AI 應判斷為 **Type 1**（明確證據：只有對/錯）
  - `aiDivergedFromPrior: true`
  - `aiOriginalDetection: 1`
- ✅ 填空題：AI 應判斷為 **Type 2**（符合 Prior Weight）
- ✅ 簡答題：AI 應判斷為 **Type 2**（符合 Prior Weight）
- ✅ 申論題：AI 可能判斷為 **Type 3**（強烈證據：開放式評價）
  - `aiDivergedFromPrior: true`
  - `aiOriginalDetection: 3`

### 測試用例 2: 多重優先級
**設定**: Prior Weight = [Type 2, Type 1, Type 3]（優先順序）

**步驟**:
1. 創建新作業，依序選擇 Type 2 → Type 1 → Type 3
2. 上傳相同的標準答案

**預期結果**:
- ✅ 優先判斷為 Type 2
- ✅ Type 2 不適合時，嘗試 Type 1
- ✅ Type 1/2 都不適合時，才判斷為 Type 3

### 測試用例 3: 無 Prior Weight
**設定**: 不選擇任何 Prior Weight

**預期結果**:
- ❌ 應該無法提交（必填驗證）
- ✅ 顯示錯誤提示：「請至少選擇一個題型屬性」

---

## 🧪 測試 3: AI 判斷準確率驗證

### 準備測試資料
建議準備 **20 題標準答案**，涵蓋不同題型：

#### Type 1 題目 (6 題)
1. 是非題：「地球是圓的。( O )」
2. 選擇題：「1+1=? (A)1 (B)2 (C)3 答案：B」
3. 選擇題：「台灣首都是？答案：台北」
4. 填空題：「H₂O 的中文名稱是____。答案：水」
5. 是非題：「太陽從西邊升起。( X )」
6. 選擇題：「下列何者是質數？(A)4 (B)6 (C)7 答案：C」

#### Type 2 題目 (7 題)
7. 填空題：「植物行____作用製造養分。答案：光合作用」
8. 簡答題：「什麼是光合作用？答案：植物利用陽光製造養分的過程」
9. 填空題：「台灣最高的山是____。答案：玉山」
10. 簡答題：「水的三態是什麼？答案：固態、液態、氣態」
11. 填空題：「一年有____個月。答案：12」
12. 簡答題：「什麼是民主？答案：人民當家作主的政治制度」
13. 填空題：「圓周率約等於____。答案：3.14」

#### Type 3 題目 (7 題)
14. 計算題：「12 × 15 = ? 答案：180（過程：12×10=120, 12×5=60, 120+60=180）」
15. 申論題：「你對校園霸凌的看法？（評分重點：觀點清晰、舉例說明、提出建議）」
16. 計算題：「圓面積：r=5，求面積。答案：78.5（過程：π×r²=3.14×25）」
17. 問答題：「說明台灣的地理位置及其重要性。（3個要點）」
18. 計算題：「解方程式 2x+3=11。答案：x=4（過程：2x=8, x=4）」
19. 作文題：「我的夢想（評分：內容20%, 結構20%, 文筆30%, 創意30%）」
20. 問答題：「分析三國鼎立的原因。（多個面向分析）」

### 測試步驟
1. 設定 Prior Weight: [Type 2, Type 1, Type 3]
2. 上傳包含上述 20 題的標準答案圖片
3. 記錄 AI 判斷結果

### 準確率計算
```
準確率 = (正確判斷題數 / 總題數) × 100%
目標: > 85%
即至少 17 題判斷正確
```

### 評分標準
| 準確率 | 評級 | 說明 |
|--------|------|------|
| 90-100% | 優秀 | Prompt 優化非常成功 |
| 85-89% | 良好 | 達標，可接受 |
| 70-84% | 尚可 | 需要微調 Prompt |
| <70% | 不佳 | 需要重新設計 Prompt |

---

## 🧪 測試 4: AI 偏離提醒機制驗證

### 測試用例 1: 應該偏離的情況
**設定**: Prior Weight = [Type 1]（只選唯一答案）

**測試題目**:
- 題目 1: 是非題「對或錯」→ 應判斷 Type 1，**不偏離**
- 題目 2: 申論題「你的看法」→ 應判斷 Type 3，**偏離**

**預期結果**:
- ✅ 題目 2 顯示 ⚠️ ICON（AlertTriangle）
- ✅ 滑鼠懸停顯示：「AI 判斷與 Prior Weight 不同 (AI判斷: Type 3)」

### 測試用例 2: 不應該偏離的情況
**設定**: Prior Weight = [Type 2, Type 1]

**測試題目**:
- 題目 1: 填空題「光合作用」→ 應判斷 Type 2，**不偏離**
- 題目 2: 選擇題「答案：B」→ 應判斷 Type 1，**不偏離**

**預期結果**:
- ✅ 所有題目都不顯示 ICON
- ✅ `aiDivergedFromPrior: false` 或 `undefined`

### 測試用例 3: 邊界情況
**設定**: Prior Weight = [Type 2]

**測試題目**:
- 題目: 「說明光合作用的過程」（可以是 Type 2 或 Type 3）

**預期結果**:
- ✅ AI 應該遵循 Prior Weight 判斷為 Type 2
- ✅ 只有在「強烈證據」時才偏離

---

## 🧪 測試 5: 重新分析功能驗證

### 測試步驟
1. 創建作業並上傳標準答案
2. 進入「編輯標準答案」modal
3. 手動修改某題的題型（例如：Type 2 → Type 3）
4. 確認該題內容被清空
5. 確認「重新分析」按鈕出現（顯示標記題數）
6. 點擊「重新分析」按鈕
7. 確認對話框提示
8. 確認重新分析完成
9. 確認 `needsReanalysis` 標記被清除

**預期結果**:
- ✅ 修改題型後，該題的 `needsReanalysis: true`
- ✅ 重新分析按鈕顯示：「重新分析 (1 題)」
- ✅ 點擊後顯示確認對話框，列出題號
- ✅ 重新分析時顯示載入狀態（旋轉圖標）
- ✅ 完成後按鈕消失
- ✅ 題目內容更新為新的 AI 判斷結果

---

## 📊 Phase 4 驗收標準

### 必須通過 (Critical)
- [ ] Prompt 長度在 800-1200 字之間
- [ ] AI 判斷準確率 > 85%
- [ ] Prior Weight 單選/多選正常運作
- [ ] AI 偏離提醒 ICON 正確顯示
- [ ] 重新分析功能正常運作

### 應該通過 (Important)
- [ ] AI 判斷準確率 > 90%
- [ ] Prior Weight 優先級順序正確
- [ ] 領域提示生效（不同領域的判斷差異）
- [ ] Type 3 兩種模式（多維度 vs 4級）正確識別

### 可選通過 (Nice to Have)
- [ ] AI 偏離率 < 15%（只在真正需要時偏離）
- [ ] 不同領域的準確率一致（國語、數學、自然等）
- [ ] 複雜題目（混合型）判斷正確

---

## 🐛 常見問題與解決方案

### 問題 1: AI 準確率低於 85%
**可能原因**:
- Prompt 描述不夠清晰
- Prior Weight 機制干擾判斷
- 領域提示不足

**解決方案**:
1. 調整 Prompt 中的「題型分類標準」描述
2. 增加更多範例
3. 調整 Prior Weight 權重（減少干擾）

### 問題 2: AI 過度偏離 Prior Weight
**可能原因**:
- Prompt 中的「強烈證據」定義不明確
- AI 對 Prior Weight 的理解不足

**解決方案**:
1. 在 Prompt 中增加具體範例
2. 強調「一般情況應遵循 Prior Weight」
3. 提供更清晰的偏離條件

### 問題 3: 重新分析按鈕不出現
**可能原因**:
- 沒有手動修改題型
- `needsReanalysis` 標記未設定

**解決方案**:
1. 確認在「編輯標準答案」modal 中操作
2. 手動修改至少一題的題型
3. 檢查開發者工具 Console 是否有錯誤

### 問題 4: Type 3 兩種模式識別錯誤
**可能原因**:
- Prompt 對兩種模式的區分不夠清晰
- 測試題目本身模糊

**解決方案**:
1. 優化 Prompt 中的描述：
   - 計算題 → rubricsDimensions（有明確步驟）
   - 申論題 → 有要點時用 rubricsDimensions，純評價用 rubric
2. 提供更清晰的範例

---

## ✅ 測試結果記錄表

| 測試項目 | 預期結果 | 實際結果 | 通過 | 備註 |
|---------|---------|---------|------|------|
| Prompt 字數（場景1） | 800-1200 | ___ | ☐ | |
| Prompt 字數（場景2） | 800-1200 | ___ | ☐ | |
| Prompt 字數（場景3） | 800-1200 | ___ | ☐ | |
| AI 準確率 | >85% | ___% | ☐ | __/20 題正確 |
| Prior Weight 單選 | 正常 | ___ | ☐ | |
| Prior Weight 多選 | 正常 | ___ | ☐ | |
| AI 偏離提醒 ICON | 正確顯示 | ___ | ☐ | |
| 重新分析功能 | 正常 | ___ | ☐ | |
| Type 3 模式識別 | 正確 | ___ | ☐ | |

---

## 🚀 Phase 4 完成後的下一步

### Phase 5: 代碼清理與優化
- [ ] 移除 GradingPage.tsx 中修改 AI 判定的 UI（可選）
- [ ] 清理未使用的代碼和註釋
- [ ] 優化效能（如有需要）

### 雲端同步測試
- [ ] 創建含有新欄位的作業，確認能正常同步到雲端
- [ ] 從雲端下載數據，確認新欄位正確反序列化
- [ ] 測試優先級選擇（1個、2個、3個）都能正常同步
- [ ] 確認舊數據（無 `priorWeightTypes`）仍能正常運作

### 最終驗收
- [ ] 端對端測試：創建作業 → AI提取 → 修改題型 → 重新分析 → 批改學生作業
- [ ] 確保所有功能正常運作
- [ ] 撰寫更新文檔（變更說明、使用指南）
