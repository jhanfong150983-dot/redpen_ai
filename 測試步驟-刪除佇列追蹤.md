# åˆªé™¤ä½‡åˆ—è¿½è¹¤æ¸¬è©¦

## å•é¡Œè¨ºæ–·

æ‚¨ç›®å‰çš„ç‹€æ³ï¼š
- âœ… æœ¬åœ° IndexedDB åˆªé™¤æˆåŠŸï¼ˆçœ‹åˆ°æ—¥èªŒï¼‰
- âŒ é›²ç«¯ Supabase æ²’æœ‰åˆªé™¤ï¼ˆæ²’çœ‹åˆ°å¾Œç«¯æ—¥èªŒï¼‰

**å¯èƒ½åŸå› **ï¼š
1. åˆªé™¤ä½‡åˆ—æ²’æœ‰è¢«ç™¼é€åˆ°ä¼ºæœå™¨
2. åŒæ­¥è«‹æ±‚æ²’æœ‰åŒ…å«åˆªé™¤è³‡æ–™
3. ä¼ºæœå™¨æ²’æœ‰è™•ç†åˆªé™¤ä½‡åˆ—

---

## æ¸¬è©¦æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šé‡æ–°ä¸Šå‚³ PDF

1. é–‹å•Ÿç€è¦½å™¨ Console (F12)
2. é–‹å•Ÿçµ‚ç«¯æ©Ÿï¼ˆæŸ¥çœ‹å¾Œç«¯æ—¥èªŒï¼‰
3. ä¸Šå‚³æ–° PDFï¼ˆè¦†è“‹èˆŠä½œæ¥­ï¼‰

**é æœŸç€è¦½å™¨ Console æ—¥èªŒ**ï¼š

```
ğŸ—‘ï¸ [PDFåŒ¯å…¥] ç™¼ç¾èˆŠä½œæ¥­ï¼Œæº–å‚™åˆªé™¤
ğŸ—‘ï¸ [PDFåŒ¯å…¥] åˆªé™¤æœ¬åœ°èˆŠä½œæ¥­ (hadGradingData: true)
âœ… [PDFåŒ¯å…¥] èˆŠä½œæ¥­å·²æ¸…é™¤
ğŸ“ [PDFåŒ¯å…¥] å»ºç«‹æ–°ä½œæ¥­
âœ… [PDFåŒ¯å…¥] æ–°ä½œæ¥­å·²åŠ å…¥æœ¬åœ°è³‡æ–™åº«
```

---

### æ­¥é©Ÿ 2ï¼šå›åˆ°é¦–é è§¸ç™¼åŒæ­¥

é»æ“Šã€Œå®Œæˆã€æˆ–å›åˆ°é¦–é ã€‚

**é æœŸç€è¦½å™¨ Console æ—¥èªŒ**ï¼š

```
ğŸ”„ [åŒæ­¥] è®€å–åˆªé™¤ä½‡åˆ—: {
  count: 1,
  items: [
    { tableName: "submissions", recordId: "old-submission-id" }
  ]
}

ğŸ“¦ [åŒæ­¥] æº–å‚™ç™¼é€åˆªé™¤è³‡æ–™: {
  submissions: 1,
  total: 1,
  deletedPayload: {
    submissions: [{ id: "old-submission-id", deletedAt: 1767... }],
    ...
  }
}
```

**âœ… æª¢æŸ¥é» 2.1**ï¼šç¢ºèª `count: 1` æˆ–æ›´å¤šï¼ˆæœ‰åˆªé™¤ä½‡åˆ—ï¼‰
**âœ… æª¢æŸ¥é» 2.2**ï¼šç¢ºèª `submissions: 1` æˆ–æ›´å¤š

---

### æ­¥é©Ÿ 3ï¼šä¼ºæœå™¨æ¥æ”¶åŒæ­¥è«‹æ±‚

**é æœŸçµ‚ç«¯æ©Ÿæ—¥èªŒ**ï¼š

```
ğŸ“¥ [API] æ”¶åˆ°åŒæ­¥è«‹æ±‚: {
  classrooms: 0,
  students: 0,
  assignments: 0,
  submissions: 1,  // â† æœ‰æ–°ä½œæ¥­è¦ä¸Šå‚³
  folders: 0,
  deleted: {
    classrooms: 0,
    students: 0,
    assignments: 0,
    submissions: 1,  // â† æœ‰èˆŠä½œæ¥­è¦åˆªé™¤ â˜…â˜…â˜…
    folders: 0
  }
}

ğŸ”„ [API] é–‹å§‹è™•ç†åˆªé™¤è«‹æ±‚...
âœ… æˆåŠŸåˆªé™¤ 1 å€‹é›²ç«¯æª”æ¡ˆ
âœ… [API] æ‰€æœ‰åˆªé™¤è™•ç†å®Œæˆ
```

**âœ… æª¢æŸ¥é» 3.1**ï¼šç¢ºèªçœ‹åˆ°ã€Œæ”¶åˆ°åŒæ­¥è«‹æ±‚ã€
**âœ… æª¢æŸ¥é» 3.2**ï¼šç¢ºèª `deleted.submissions: 1` **ï¼ˆé—œéµï¼ï¼‰**
**âœ… æª¢æŸ¥é» 3.3**ï¼šç¢ºèªçœ‹åˆ°ã€Œé–‹å§‹è™•ç†åˆªé™¤è«‹æ±‚ã€
**âœ… æª¢æŸ¥é» 3.4**ï¼šç¢ºèªçœ‹åˆ°ã€ŒæˆåŠŸåˆªé™¤ N å€‹é›²ç«¯æª”æ¡ˆã€

---

### æ­¥é©Ÿ 4ï¼šä¸Šå‚³æ–°ä½œæ¥­åˆ°é›²ç«¯

**é æœŸçµ‚ç«¯æ©Ÿæ—¥èªŒ**ï¼š

```
ğŸ“¤ [ä¸Šå‚³] é–‹å§‹ä¸Šå‚³æª”æ¡ˆ: {
  submissionId: "new-submission-id",
  assignmentId: "xxx",
  studentId: "xxx",
  filePath: "submissions/new-submission-id.webp",
  fileSize: "123.45 KB"
}

âœ… [ä¸Šå‚³] æª”æ¡ˆä¸Šå‚³æˆåŠŸ: submissions/new-submission-id.webp

ğŸ—‘ï¸ [è¦†è“‹] ç™¼ç¾èˆŠä½œæ¥­ï¼Œæº–å‚™åˆªé™¤: {
  oldId: "old-submission-id",
  newId: "new-submission-id",
  assignmentId: "xxx",
  studentId: "xxx"
}

âœ… [è¦†è“‹] å·²åˆªé™¤èˆŠä½œæ¥­è³‡æ–™åº«è¨˜éŒ„: old-submission-id
âœ… [è¦†è“‹] å·²åˆªé™¤èˆŠä½œæ¥­é›²ç«¯æª”æ¡ˆ: submissions/old-submission-id.webp

ğŸ’¾ [è³‡æ–™åº«] é–‹å§‹æ’å…¥æ–° submission
âœ… [è³‡æ–™åº«] æ–° submission å¯«å…¥æˆåŠŸ
ğŸ‰ [å®Œæˆ] PDF ä¸Šå‚³æµç¨‹å®Œæˆ
```

**âœ… æª¢æŸ¥é» 4.1**ï¼šç¢ºèªçœ‹åˆ°ã€Œæª”æ¡ˆä¸Šå‚³æˆåŠŸã€
**âœ… æª¢æŸ¥é» 4.2**ï¼šç¢ºèªçœ‹åˆ°ã€Œç™¼ç¾èˆŠä½œæ¥­ï¼Œæº–å‚™åˆªé™¤ã€
**âœ… æª¢æŸ¥é» 4.3**ï¼šç¢ºèªçœ‹åˆ°ã€Œå·²åˆªé™¤èˆŠä½œæ¥­é›²ç«¯æª”æ¡ˆã€

---

## å¸¸è¦‹å•é¡Œè¨ºæ–·

### å•é¡Œ Aï¼šçœ‹ä¸åˆ°ã€Œè®€å–åˆªé™¤ä½‡åˆ—ã€æ—¥èªŒ

**åŸå› **ï¼šåŒæ­¥æ²’æœ‰è¢«è§¸ç™¼

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. æ‰‹å‹•é»æ“Šé¦–é çš„ã€ŒåŒæ­¥ã€æŒ‰éˆ•
2. æª¢æŸ¥ `requestSync()` æ˜¯å¦è¢«å‘¼å«
3. æª¢æŸ¥ç€è¦½å™¨ Console æ˜¯å¦æœ‰éŒ¯èª¤

---

### å•é¡Œ Bï¼šã€Œåˆªé™¤ä½‡åˆ— count: 0ã€

**åŸå› **ï¼šåˆªé™¤æ²’æœ‰åŠ å…¥ä½‡åˆ—

**æª¢æŸ¥**ï¼š
```javascript
// åœ¨ç€è¦½å™¨ Console åŸ·è¡Œ
const { db } = await import('./lib/db')
const queue = await db.syncQueue.toArray()
console.log('ä½‡åˆ—å…§å®¹:', queue)
```

**é æœŸçµæœ**ï¼šæ‡‰è©²çœ‹åˆ° action: "delete" çš„è¨˜éŒ„

**å¦‚æœæ²’æœ‰**ï¼š
- æª¢æŸ¥ `queueDeleteMany` æ˜¯å¦è¢«å‘¼å«
- æª¢æŸ¥ AssignmentImport.tsx çš„åˆªé™¤é‚è¼¯

---

### å•é¡Œ Cï¼šã€Œdeleted.submissions: 0ã€ï¼ˆæœ€å¯èƒ½ï¼‰

**åŸå› **ï¼šåˆªé™¤ä½‡åˆ—æ²’æœ‰è¢«åŒ…å«åœ¨åŒæ­¥è«‹æ±‚ä¸­

**æª¢æŸ¥ç€è¦½å™¨ Console**ï¼š
```
ğŸ“¦ [åŒæ­¥] æº–å‚™ç™¼é€åˆªé™¤è³‡æ–™: {
  submissions: 0,  // â† æ‡‰è©²æ˜¯ 1
  total: 0,        // â† æ‡‰è©²æ˜¯ 1
  ...
}
```

**åŸå› åˆ†æ**ï¼š
- `deleteMap` æ²’æœ‰æ­£ç¢ºå»ºç«‹
- `deletedPayload` æ²’æœ‰æ­£ç¢ºå¡«å……
- ç¶²è·¯è«‹æ±‚æ²’æœ‰åŒ…å« `deleted` æ¬„ä½

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
æª¢æŸ¥ useSync.ts çš„ `pushMetadata` å‡½æ•¸

---

### å•é¡Œ Dï¼šä¼ºæœå™¨æ²’æœ‰è™•ç†åˆªé™¤

**æª¢æŸ¥çµ‚ç«¯æ©Ÿ**ï¼š
```
ğŸ“¥ [API] æ”¶åˆ°åŒæ­¥è«‹æ±‚: {
  deleted: {
    submissions: 1  // â† æœ‰æ”¶åˆ°
  }
}

// ä½†æ²’æœ‰çœ‹åˆ°ï¼š
ğŸ”„ [API] é–‹å§‹è™•ç†åˆªé™¤è«‹æ±‚...
```

**åŸå› **ï¼š`applyDeletes` å‡½æ•¸å‡ºéŒ¯

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
æª¢æŸ¥çµ‚ç«¯æ©Ÿæ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯

---

## å¿«é€Ÿæª¢æŸ¥è…³æœ¬

åœ¨ç€è¦½å™¨ Console åŸ·è¡Œï¼š

```javascript
// 1. æª¢æŸ¥åˆªé™¤ä½‡åˆ—
const { db } = await import('./lib/db')
const queue = await db.syncQueue.toArray()
console.log('ğŸ“Š åˆªé™¤ä½‡åˆ—:', queue.filter(q => q.action === 'delete'))

// 2. æª¢æŸ¥æœ¬åœ° submissions
const submissions = await db.submissions.toArray()
console.log('ğŸ“Š æœ¬åœ° submissions:', submissions.length, submissions)

// 3. æ‰‹å‹•è§¸ç™¼åŒæ­¥
const { requestSync } = await import('./lib/sync-events')
requestSync()
console.log('ğŸ”„ å·²è§¸ç™¼åŒæ­¥')
```

---

## æˆåŠŸæ¨™æº–

æ‰€æœ‰é€™äº›æ—¥èªŒéƒ½æ‡‰è©²å‡ºç¾ï¼š

**ç€è¦½å™¨ Console**ï¼š
- âœ… ğŸ”„ [åŒæ­¥] è®€å–åˆªé™¤ä½‡åˆ—: count: 1
- âœ… ğŸ“¦ [åŒæ­¥] æº–å‚™ç™¼é€åˆªé™¤è³‡æ–™: submissions: 1

**çµ‚ç«¯æ©Ÿ**ï¼š
- âœ… ğŸ“¥ [API] æ”¶åˆ°åŒæ­¥è«‹æ±‚: deleted.submissions: 1
- âœ… ğŸ”„ [API] é–‹å§‹è™•ç†åˆªé™¤è«‹æ±‚
- âœ… âœ… æˆåŠŸåˆªé™¤ 1 å€‹é›²ç«¯æª”æ¡ˆ
- âœ… ğŸ—‘ï¸ [è¦†è“‹] ç™¼ç¾èˆŠä½œæ¥­ï¼Œæº–å‚™åˆªé™¤
- âœ… âœ… [è¦†è“‹] å·²åˆªé™¤èˆŠä½œæ¥­é›²ç«¯æª”æ¡ˆ

å¦‚æœç¼ºå°‘ä»»ä½•ä¸€å€‹ï¼Œè«‹å‘Šè¨´æˆ‘å…·é«”ç¼ºå°‘å“ªä¸€å€‹ï¼
